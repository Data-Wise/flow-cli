# Quarto Workflow Enhancements - Implementation Ready Summary

**Generated:** 2026-01-20
**Questions Answered:** 84 expert questions across 10 topic areas
**Status:** âœ… Production-ready specification with zero ambiguity

---

## ğŸ“Š Specification Coverage

| Topic Area                 | Questions | Status      | Documentation          |
| -------------------------- | --------- | ----------- | ---------------------- |
| **Core Implementation**    | Q1-Q12    | âœ… Complete | BRAINSTORM + SPEC      |
| **Advanced Features**      | Q13-Q17   | âœ… Complete | BRAINSTORM + SPEC      |
| **Implementation Details** | Q18-Q21   | âœ… Complete | BRAINSTORM             |
| **Edge Cases & UX**        | Q22-Q31   | âœ… Complete | BRAINSTORM             |
| **Advanced Scenarios**     | Q32-Q39   | âœ… Complete | BRAINSTORM             |
| **Daily Deployment**       | Q40-Q53   | âœ… Complete | TEACH-DEPLOY-DEEP-DIVE |
| **Hybrid Rendering**       | Q54-Q57   | âœ… Complete | PARTIAL-DEPLOY-INDEX   |
| **Index Management**       | Q58-Q69   | âœ… Complete | PARTIAL-DEPLOY-INDEX   |
| **Final Polish**           | Q70-Q74   | âœ… Complete | BRAINSTORM             |
| **Production Readiness**   | Q75-Q84   | âœ… Complete | BRAINSTORM             |

**Total:** 84 questions, ~22,000 lines of documentation

---

## ğŸ¯ Phase 1 Feature List (v4.6.0)

### Core Commands (8 new/enhanced)

| Command                  | Status   | Description                                     |
| ------------------------ | -------- | ----------------------------------------------- |
| `teach init`             | Enhanced | Template-based Quarto project creation          |
| `teach hooks install`    | New      | Install pre-commit/pre-push hooks               |
| `teach hooks upgrade`    | New      | Upgrade existing hooks to latest version        |
| `teach validate`         | New      | Staged validation (YAML â†’ syntax â†’ render)      |
| `teach validate --watch` | New      | Continuous validation during development        |
| `teach cache`            | New      | Interactive freeze cache management             |
| `teach clean`            | New      | Delete \_freeze/ + \_site/                      |
| `teach doctor`           | New      | Full health check (deps, config, extensions)    |
| `teach deploy`           | Enhanced | Hybrid rendering + partial deploys + index mgmt |
| `teach backup`           | New      | Snapshot course before major changes            |
| `teach status`           | Enhanced | Full dashboard (cache, deploys, index health)   |

---

## ğŸ”§ Hook System Architecture

### Pre-Commit Hook (5 Layers)

````zsh
#!/usr/bin/env zsh
# .git/hooks/pre-commit (auto-generated by teach hooks install)

# Layer 1: YAML Frontmatter Validation
# - Check for --- delimiter
# - Use yq to parse YAML syntax

# Layer 2: Quarto Syntax Check
# - quarto inspect file.qmd
# - Catches malformed markdown, invalid code chunks

# Layer 3: Full Render (if QUARTO_PRE_COMMIT_RENDER=1)
# - quarto render file.qmd
# - Uses freeze cache (fast: 1-5s per file)
# - Parallel rendering for multiple files (auto-detect cores)

# Layer 4: Empty Code Chunk Detection (warning)
# - Detect ```{r}\s*``` pattern

# Layer 5: Image Reference Validation (warning)
# - Extract ![...](path) links
# - Check file existence

# Special: _freeze/ Commit Prevention (CRITICAL)
# - Block if _freeze/ is staged
# - Error: "Run: git restore --staged _freeze/"

# Interactive Error Handling
# - Show errors with last 15 lines
# - Prompt: "Commit anyway? [y/N]"
````

**Performance:** 1-5s per file (with freeze), parallel for multiple files

---

### Pre-Push Hook (Production Branch Only)

```zsh
#!/usr/bin/env zsh
# .git/hooks/pre-push

# Only run on production/main branch
if [[ "$remote_ref" != *"production"* && "$remote_ref" != *"main"* ]]; then
    exit 0
fi

# Full site validation
quarto render --profile production

# If failure â†’ BLOCK push
```

**Performance:** 2-5 minutes (full site render without freeze)

---

### prepare-commit-msg Hook (Optional)

```zsh
# Append validation time to commit message
# Example: "Update week 5 lecture (validated in 3.2s)"
```

---

## ğŸ“‹ teach validate - Complete Specification

### Granular Validation Layers (Q80)

```bash
# Full validation (default)
teach validate
# â†’ YAML + syntax + render

# Quick validation (syntax only)
teach validate --yaml --syntax
# â†’ Skips render (fast)

# Render only (assume syntax OK)
teach validate --render
# â†’ Just render step

# All layers explicit
teach validate --yaml --syntax --render
# â†’ Same as default
```

### Watch Mode (Q77 - Phase 1)

```bash
teach validate --watch

# Monitors file changes
# On save:
#   1. Run validation (background)
#   2. Show results in terminal
#   3. Update .teach/validation-status.json

# Conflict detection:
#   - If quarto preview running, warn user
#   - Skip validation if file locked by IDE
```

**Race Condition Prevention:**

- Detect `.quarto-preview.pid`
- Check file locks before rendering
- Debounce file changes (wait 500ms for batch edits)

---

## ğŸš€ teach deploy - Daily Workflow

### Single-Command Deployment

```bash
teach deploy lectures/week-05.qmd

# Steps:
# 1. Auto-commit uncommitted changes (with prompt)
# 2. Detect dependencies (cross-references)
# 3. Validate cross-references
# 4. Update home_lectures.qmd (with prompt)
# 5. Auto-sort index links
# 6. Local syntax check (YAML + quarto inspect)
# 7. Commit all changes
# 8. Push to production
# 9. Auto-tag: deploy-YYYY-MM-DD-HHMM
# 10. CI builds full site

# Performance:
#   Local: 30-60s
#   CI: 2-5 min
#   Total: ~3-6 min
```

### Partial Deploy with Dependency Tracking

```bash
teach deploy lectures/week-05.qmd

# Dependency detection:
#   - Parse source("path") â†’ add path
#   - Parse @sec-id â†’ find defining file
#   - Parse cross-references â†’ add linked files

# Result: Render week-05 + all files it depends on
```

### Hybrid Rendering (Q54)

**Local (fast):**

- YAML validation
- Quarto syntax check
- Cross-reference validation
- Dependency tracking

**CI/CD (thorough):**

- Full site render (production profile)
- Generate \_site/
- Deploy to GitHub Pages

**Why Hybrid:**

- Fast feedback (local: 1-5s)
- Reproducible build (CI: fresh environment)
- \_site/ not in git (cleaner repo)

---

## ğŸ“š Index Management - ADD/UPDATE/REMOVE

### Adding New Lecture (Q58, Q64)

```bash
teach deploy lectures/week-05.qmd

# Detection:
#   1. Git status: new file
#   2. Parse home_lectures.qmd: no matching link

# Prompt:
#   â†’ New lecture: "Week 5: Factorial ANOVA"
#   â†’ Add to home_lectures.qmd? [Y/n] y

# Actions:
#   1. Extract title from YAML frontmatter
#   2. Create markdown link
#   3. Find insertion point (auto-sort by week number)
#   4. Insert link
#   5. Commit index update with lecture
```

### Updating Existing Lecture (Q63, Q65)

```bash
teach deploy lectures/week-05.qmd

# Detection:
#   1. Git status: modified file
#   2. Parse home_lectures.qmd: link exists
#   3. Compare titles (old vs new)

# Prompt (if title changed):
#   â†’ Old: "Week 5: ANOVA"
#   â†’ New: "Week 5: Factorial ANOVA and Contrasts"
#   â†’ Update link? [y/N] y

# Action:
#   Replace title in markdown link
```

### Removing Deprecated Lecture (Q67)

```bash
# User deletes file
rm lectures/week-01.qmd
git add lectures/week-01.qmd

teach deploy

# Detection:
#   1. Git diff: deleted file
#   2. Parse home_lectures.qmd: link exists

# Prompt:
#   â†’ Deleted: week-01.qmd
#   â†’ Link: "Week 1: Introduction"
#   â†’ Remove link? [Y/n] y

# Action:
#   Delete line with link from index
```

### Auto-Sorting (Q64, Q66, Q68)

**Standard lectures:**

```bash
# Parse week number from filename
# week-05.qmd â†’ sort_key = 5
# Sort numerically
```

**Non-standard lectures:**

```yaml
---
title: 'Guest Lecture: Industry Applications'
sort_order: 5.5 # Between week 5 and 6
---
```

**Result:**

```markdown
- [Week 5: Factorial ANOVA](lectures/week-05.qmd)
- [Guest Lecture: Industry Applications](lectures/guest.qmd)
- [Week 6: Mixed Models](lectures/week-06.qmd)
```

---

## ğŸ¥ teach doctor - Full Health Check

### Checks Performed (Q15, Q81)

```bash
teach doctor

# Output:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  teach doctor - Health Check                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ Quarto 1.6.40                            â”‚
â”‚  âœ“ Git 2.39.0                               â”‚
â”‚  âœ“ Git repository                           â”‚
â”‚  âœ“ Freeze caching enabled                   â”‚
â”‚  âœ“ Pre-commit hook installed (v2.0.0)       â”‚
â”‚  âœ“ Pre-push hook installed (v2.0.0)         â”‚
â”‚  âœ“ Freeze cache: 71MB (342 files)           â”‚
â”‚  âš   Missing: yq (YAML processor)            â”‚
â”‚     â†’ Install? [Y/n] y                      â”‚
â”‚     â†’ Running: brew install yq              â”‚
â”‚  âœ“ yq installed                             â”‚
â”‚  âœ“ R packages: 15/15 available              â”‚
â”‚  âœ“ Quarto extensions: 2/2 compatible        â”‚
â”‚  âœ“ All lectures linked in index             â”‚
â”‚  â„¹  Quarto preview not running              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… All checks passed                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Interactive Fix (Q81)

**Missing dependency:**

```bash
teach doctor

# Output:
â”‚  âœ— yq not found
â”‚  Install via Homebrew? [Y/n] y
â”‚  â†’ brew install yq
â”‚  âœ“ yq installed

â”‚  âœ— R package 'ggplot2' not found
â”‚  Install? [Y/n] y
â”‚  â†’ Rscript -e "install.packages('ggplot2')"
â”‚  âœ“ ggplot2 installed
```

**Extension version mismatch:**

```bash
teach doctor

# Output:
â”‚  âš   Extension 'unm' version mismatch
â”‚     Required: >=1.6.0
â”‚     Installed: 1.5.2
â”‚  Update extension? [Y/n] y
â”‚  â†’ quarto add quarto-ext/unm
â”‚  âœ“ Extension updated
```

---

## ğŸ“Š teach status - Full Dashboard (Q74)

```bash
teach status

# Output:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAT 545 - Spring 2026                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ“ Project                                                     â”‚
â”‚     Path: ~/projects/teaching/stat-545                          â”‚
â”‚     Type: Quarto website                                        â”‚
â”‚     Branch: draft                                               â”‚
â”‚                                                                 â”‚
â”‚  ğŸ”§ Quarto                                                      â”‚
â”‚     Freeze: âœ“ enabled (71MB cache, 342 files)                  â”‚
â”‚     Incremental: âœ“ enabled                                     â”‚
â”‚     Profile: dev (production available)                         â”‚
â”‚                                                                 â”‚
â”‚  ğŸ£ Git Hooks                                                   â”‚
â”‚     Pre-commit: âœ“ installed (v2.0.0)                            â”‚
â”‚     Pre-push: âœ“ installed (v2.0.0)                              â”‚
â”‚     Last validation: 2 hours ago                                â”‚
â”‚                                                                 â”‚
â”‚  ğŸš€ Deployments                                                 â”‚
â”‚     Last deploy: 2026-01-20 12:30 (4 hours ago)                 â”‚
â”‚     Tag: deploy-2026-01-20-1230                                 â”‚
â”‚     Files: 3 lectures, 2 assignments                            â”‚
â”‚     Pending changes: 1 lecture (week-06.qmd)                    â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“š Index Health                                                â”‚
â”‚     home_lectures.qmd: âœ“ 5 lectures linked                     â”‚
â”‚     home_assignments.qmd: âœ“ 5 assignments linked               â”‚
â”‚     Missing links: 1 (week-06.qmd)                              â”‚
â”‚                                                                 â”‚
â”‚  â±ï¸  Performance                                                â”‚
â”‚     Last render: 38s (freeze cache used)                        â”‚
â”‚     Avg render time: 42s                                        â”‚
â”‚     CI build time: 2m 15s                                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Next steps:
  â€¢ Deploy week-06: teach deploy lectures/week-06.qmd
  â€¢ Add to index: Prompt will appear on deploy
```

---

## ğŸ”„ Rollback System (Q42, Q70, Q84)

### Auto-Rollback on CI Failure (Q70)

```bash
teach deploy lectures/week-05.qmd

# Local validation passes
# Push to production
# CI build starts...
# CI build FAILS (e.g., R error in week-05)

# Auto-rollback triggered:
# â†’ CI failure detected
# â†’ Reverting production to: deploy-2026-01-19-1430
# â†’ Git reset --hard deploy-2026-01-19-1430
# â†’ Force push to production
# âœ… Rolled back automatically
#
# âš ï¸  Fix errors locally and retry:
#    teach deploy lectures/week-05.qmd
```

### Manual Rollback

```bash
# View deployment history
git tag -l "deploy-*" | tail -5
# deploy-2026-01-18-1430
# deploy-2026-01-19-0915
# deploy-2026-01-19-1430
# deploy-2026-01-20-0945

# Rollback to previous
teach deploy --rollback deploy-2026-01-19-1430

# Output:
# â†’ Rolling back production to: deploy-2026-01-19-1430
# â†’ Resetting production branch...
# â†’ Force pushing...
# âœ… Rolled back successfully
```

### Partial Rollback (Q84 - Interactive)

```bash
teach deploy --rollback deploy-2026-01-19-1430

# Interactive prompt:
# â†’ Rollback includes:
#     â€¢ lectures/week-05.qmd
#     â€¢ assignments/hw-05.qmd
#     â€¢ home_lectures.qmd
#
# Rollback all files? [Y/n] n
#
# Select files to rollback:
#   [x] lectures/week-05.qmd
#   [ ] assignments/hw-05.qmd
#   [x] home_lectures.qmd
#
# Rollback selected files? [Y/n] y
#
# â†’ Cherry-picking rollback...
# âœ… Rolled back 2 files, kept 1 file
```

---

## ğŸ¨ UX Details

### Progress Indicators (Q83)

**Slow render (> 30s):**

```bash
teach validate

# Output:
Validating lectures/week-05.qmd...
  âœ“ YAML valid
  âœ“ Syntax valid
  Rendering (this may take a while)...
  â±ï¸  Elapsed: 15s... 30s... 45s... 60s
  âœ“ Render complete (62s)
```

**Parallel rendering:**

```bash
teach validate lectures/*.qmd

# Output:
Rendering 5 files in parallel...
  [1/5] week-01.qmd âœ“ (3s)
  [2/5] week-02.qmd âœ“ (5s)
  [3/5] week-03.qmd â±ï¸  (15s...)
  [4/5] week-04.qmd âœ“ (4s)
  [5/5] week-05.qmd âœ“ (7s)
  [3/5] week-03.qmd âœ“ (22s)

âœ… All files validated (22s total, 5s average)
```

### Hook Version Management (Q75)

```bash
teach hooks install

# Detects existing hooks
# Output:
â”‚  âš   Existing hooks detected (v1.0.0)
â”‚     New version available: v2.0.0
â”‚
â”‚     Changes in v2.0.0:
â”‚       â€¢ Added image reference validation
â”‚       â€¢ Parallel rendering support
â”‚       â€¢ Progress indicators
â”‚
â”‚  Upgrade hooks? [Y/n] y
â”‚  â†’ Backing up to: .git/hooks/pre-commit.v1.0.0
â”‚  â†’ Installing v2.0.0...
â”‚  âœ… Hooks upgraded
```

### Amend Commit Handling (Q76)

```bash
# First commit
git commit -m "Add week 5"
# â†’ Pre-commit validates, renders (5s)

# Amend commit (typo fix)
git commit --amend
# â†’ Pre-commit STILL validates + renders (5s)
# â†’ Ensures amended code is still valid
```

---

## ğŸ“¦ Migration Path (Q79)

### Upgrading Existing STAT 545 Project

```bash
cd ~/projects/teaching/stat-545

teach init --upgrade

# Detection:
#   1. Finds existing .git/hooks/
#   2. Finds existing _quarto.yml
#   3. Finds existing scripts/setup-hooks.sh

# Prompt:
#   â†’ Existing Quarto project detected
#   â†’ Current hooks: custom (215 lines)
#   â†’ Replace with flow-cli hooks? [Y/n] y
#
#   â†’ Backup custom hooks? [Y/n] y
#   â†’ Backed up to: .git/hooks/pre-commit.backup
#
#   â†’ Install flow-cli hooks (v2.0.0)? [Y/n] y
#   âœ… Hooks installed
#
#   â†’ Merge _quarto.yml settings
#   â†’ Existing: freeze: auto
#   â†’ flow-cli adds: execute: incremental: true
#   â†’ Apply? [Y/n] y
#   âœ… _quarto.yml updated
#
#   â†’ Create teaching.yml config
#   âœ… Created: ~/.config/flow/teaching.yml
#
# Migration complete!
#   â€¢ Hooks: flow-cli v2.0.0
#   â€¢ Config: teaching.yml
#   â€¢ Backup: .git/hooks/*.backup
#
# Test: teach validate
```

---

## ğŸ§ª Testing Strategy

### Unit Tests

**Mock project:** `tests/fixtures/teaching-quarto-test/`

**Test suites:**

1. `test-teach-hooks-unit.zsh` - Hook installation logic
2. `test-teach-validate-unit.zsh` - Validation layers
3. `test-teach-cache-unit.zsh` - Cache management
4. `test-teach-deploy-unit.zsh` - Deploy logic
5. `test-index-management-unit.zsh` - ADD/UPDATE/REMOVE

### Integration Tests

**Real project:** ~/projects/teaching/stat-545

**Test scenarios:**

1. Full workflow: init â†’ edit â†’ validate â†’ deploy
2. Index management: add â†’ update â†’ remove
3. Rollback: deploy â†’ rollback â†’ verify
4. Hook upgrades: v1.0 â†’ v2.0
5. Migration: existing project â†’ flow-cli

---

## ğŸ“š Documentation Deliverables

1. **TEACHING-QUARTO-WORKFLOW.md** (10,000+ lines)
   - Complete user guide
   - All commands documented
   - Examples and troubleshooting

2. **TEACH-DISPATCHER-REFERENCE.md** (updated)
   - API reference for all commands
   - Flags and options

3. **CONVENTIONS.md** (updated)
   - Hook template conventions
   - Index management patterns

4. **PHILOSOPHY.md** (updated)
   - ADHD-friendly design principles
   - Daily deployment rationale

---

## ğŸ¯ Success Metrics

| Metric                 | Target          | Measurement                   |
| ---------------------- | --------------- | ----------------------------- |
| **Performance**        |
| Pre-commit (1 file)    | < 5s            | Freeze cache enabled          |
| Pre-commit (5 files)   | < 10s           | Parallel rendering            |
| teach deploy (local)   | < 60s           | Hybrid validation             |
| CI build               | 2-5 min         | Full site render              |
| **Reliability**        |
| Broken commits         | 0%              | Pre-commit validation         |
| CI failures            | < 5%            | Local validation catches most |
| Hook conflicts         | 0               | Interactive upgrade           |
| **Adoption**           |
| New projects           | 100%            | Auto-configured               |
| Existing migrations    | 50% in 3 months | teach init --upgrade          |
| Documentation coverage | 100%            | All features documented       |

---

## âœ… Ready for Implementation

**Total specification:**

- âœ… 84 expert questions answered
- âœ… ~22,000 lines of documentation
- âœ… 6 comprehensive specification documents
- âœ… Zero ambiguity on any feature
- âœ… Production-validated patterns (STAT 545)
- âœ… Complete test strategy
- âœ… Migration path defined

**Phase 1 timeline:** 8 weeks (~15 hours per week)

**Next step:** Create atomic commit plan or start coding

---

**Author:** DT
**Specification Version:** 1.0.0
**Status:** âœ… Implementation Ready
