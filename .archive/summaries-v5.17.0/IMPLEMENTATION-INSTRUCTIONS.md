# Quarto Workflow Complete Implementation - All Phases

**Branch:** `feature/quarto-workflow`
**Target Version:** v4.6.0 â†’ v4.8.0 (Complete implementation)
**Timeline:** 16 weeks (~15 hours/week)
**Parent Branch:** dev

---

## ğŸ“‹ Overview

Complete implementation of Quarto workflow enhancements for flow-cli's teaching system, covering all features from Phase 1, Phase 2, and Phase 3:

**Phase 1 - Core Features (Weeks 1-8):**

- Git hook system (pre-commit, pre-push, prepare-commit-msg)
- Validation commands (teach validate, teach validate --watch)
- Cache management (teach cache, teach clean)
- Health checks (teach doctor)
- Enhanced deployment (teach deploy with partial support)
- Backup system (teach backup)
- Status dashboard (teach status enhancements)

**Phase 2 - Enhancements (Weeks 9-12):**

- Quarto profile management
- R package auto-installation
- Parallel rendering optimization
- Custom validation rules
- Advanced caching strategies
- Performance monitoring

**Phase 3 - Advanced Features (Weeks 13-16):**

- Template system for course initialization
- Comprehensive backup management
- Auto-rollback on CI failures
- Multi-environment deployment
- Advanced error recovery
- Migration tools for existing projects

---

## ğŸ¯ Complete Feature List

### Core Commands (21 new/enhanced)

| Command                                | Type     | Description                                     |
| -------------------------------------- | -------- | ----------------------------------------------- |
| **Phase 1: Core (8 commands)**         |
| `teach init`                           | Enhanced | Template-based Quarto project creation          |
| `teach hooks install`                  | New      | Install pre-commit/pre-push hooks               |
| `teach hooks upgrade`                  | New      | Upgrade existing hooks to latest version        |
| `teach validate`                       | New      | Staged validation (YAML â†’ syntax â†’ render)      |
| `teach validate --watch`               | New      | Continuous validation during development        |
| `teach cache`                          | New      | Interactive freeze cache management             |
| `teach clean`                          | New      | Delete \_freeze/ + \_site/                      |
| `teach doctor`                         | New      | Full health check (deps, config, extensions)    |
| `teach deploy`                         | Enhanced | Hybrid rendering + partial deploys + index mgmt |
| `teach backup`                         | New      | Snapshot course before major changes            |
| `teach status`                         | Enhanced | Full dashboard (cache, deploys, index health)   |
| **Phase 2: Enhancements (6 commands)** |
| `teach profiles list`                  | New      | List available Quarto profiles                  |
| `teach profiles set <name>`            | New      | Switch active profile                           |
| `teach profiles create <name>`         | New      | Create new profile                              |
| `teach doctor --fix`                   | Enhanced | Interactive dependency installation             |
| `teach validate --stats`               | Enhanced | Performance statistics                          |
| `teach cache analyze`                  | Enhanced | Detailed cache analysis                         |
| **Phase 3: Advanced (7 commands)**     |
| `teach templates list`                 | New      | List available templates                        |
| `teach templates apply <name>`         | New      | Apply template to project                       |
| `teach templates create <name>`        | New      | Create template from project                    |
| `teach deploy --rollback <tag>`        | Enhanced | Auto-rollback on CI failure                     |
| `teach deploy --env <name>`            | Enhanced | Multi-environment deployment                    |
| `teach errors`                         | New      | Error history and recovery                      |
| `teach migrate`                        | New      | Migration from existing projects                |

---

## ğŸ“… 16-Week Implementation Schedule

### PHASE 1: Core Features (Weeks 1-8)

#### Week 1-2: Hook System Foundation

**Goal:** Implement 5-layer pre-commit hook system

**Files to create:**

- `lib/hooks/pre-commit-template.zsh` - 5-layer validation hook
- `lib/hooks/pre-push-template.zsh` - Production branch validation
- `lib/hooks/prepare-commit-msg-template.zsh` - Append validation time
- `lib/hook-installer.zsh` - Hook installation/upgrade logic

**Hook Architecture:**

````zsh
#!/usr/bin/env zsh
# .git/hooks/pre-commit (auto-generated by teach hooks install)

# Layer 1: YAML Frontmatter Validation
_validate_yaml() {
    local file="$1"
    # Check for --- delimiter
    grep -qE '^---' "$file" || return 1
    # Use yq to parse YAML syntax
    yq eval . "$file" &>/dev/null || return 1
}

# Layer 2: Quarto Syntax Check
_validate_syntax() {
    local file="$1"
    quarto inspect "$file" &>/dev/null
}

# Layer 3: Full Render (if QUARTO_PRE_COMMIT_RENDER=1)
_render_file() {
    local file="$1"
    [[ "${QUARTO_PRE_COMMIT_RENDER:-0}" == "1" ]] || return 0
    quarto render "$file" --quiet
}

# Layer 4: Empty Code Chunk Detection (warning)
_check_empty_chunks() {
    local file="$1"
    if grep -qE '```\{r\}\s*```' "$file"; then
        echo "âš ï¸  Warning: Empty code chunk in $file"
    fi
}

# Layer 5: Image Reference Validation (warning)
_check_images() {
    local file="$1"
    grep -oP '!\[.*?\]\(\K[^)]+' "$file" | while read img; do
        [[ ! -f "$img" ]] && echo "âš ï¸  Warning: Missing image: $img"
    done
}

# Special: _freeze/ Commit Prevention
_check_freeze() {
    if git diff --cached --name-only | grep -q '^_freeze/'; then
        echo "âŒ Error: Cannot commit _freeze/ directory"
        echo "   Run: git restore --staged _freeze/"
        return 1
    fi
}

# Interactive Error Handling
_prompt_commit_anyway() {
    echo ""
    read "?Commit anyway? [y/N] " response
    [[ "$response" =~ ^[Yy]$ ]]
}
````

**Testing:**

- `tests/test-teach-hooks-unit.zsh` - Hook installation, version management
- Test parallel rendering for multiple files
- Test interactive error prompts

**Deliverable:** Working hook system with interactive error handling

---

#### Week 2-3: Validation Commands

**Goal:** Implement granular validation with watch mode

**Files to create:**

- `lib/validation-helpers.zsh` - Shared validation functions
- `commands/teach-validate.zsh` - Standalone validation command

**Granular Validation:**

```bash
teach validate                  # Full validation (YAML + syntax + render)
teach validate --yaml           # YAML only (fast)
teach validate --syntax         # Syntax only
teach validate --render         # Render only
teach validate --watch          # Continuous validation
```

**Watch Mode Implementation:**

```zsh
teach validate --watch

# Monitor file changes using fswatch/inotifywait
# On save:
#   1. Run validation (background)
#   2. Show results in terminal
#   3. Update .teach/validation-status.json

# Race condition prevention:
#   - Detect .quarto-preview.pid
#   - Skip validation if file locked by IDE
#   - Debounce file changes (wait 500ms)
```

**Testing:**

- `tests/test-teach-validate-unit.zsh` - Validation layers
- Test watch mode with mock file changes
- Test conflict detection with quarto preview

**Deliverable:** Granular validation with watch mode

---

#### Week 3-4: Cache Management

**Goal:** Interactive cache management with analysis

**Files to create:**

- `lib/cache-helpers.zsh` - Freeze cache utilities
- `commands/teach-cache.zsh` - Interactive cache management

**Cache Commands:**

```bash
teach cache             # Interactive menu
teach cache status      # Show size, file count
teach cache clear       # Delete _freeze/ (with confirmation)
teach cache rebuild     # Force full re-render
teach clean             # Delete _freeze/ + _site/
```

**Interactive Menu:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Freeze Cache Management                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Cache: 71MB (342 files)                    â”‚
â”‚  Last render: 2 hours ago                   â”‚
â”‚                                             â”‚
â”‚  1. View cache details                      â”‚
â”‚  2. Clear cache (delete _freeze/)           â”‚
â”‚  3. Rebuild cache (force re-render)         â”‚
â”‚  4. Exit                                    â”‚
â”‚                                             â”‚
â”‚  Choice: _                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Testing:**

- `tests/test-teach-cache-unit.zsh` - Cache management
- Mock \_freeze/ directory
- Test interactive prompts

**Deliverable:** Interactive cache management

---

#### Week 4-5: Health Checks

**Goal:** Comprehensive health check with interactive fix

**Files to create:**

- `lib/doctor-helpers.zsh` - Health check functions
- `commands/teach-doctor.zsh` - Health check command

**Health Checks:**

```bash
teach doctor            # Full health check
teach doctor --fix      # Interactive fix
teach doctor --json     # JSON output for CI
teach doctor --quiet    # Minimal output
```

**Checks Performed:**

1. Dependencies (Quarto, Git, yq, R packages, extensions)
2. Git setup (repository, remote, branches)
3. Project config (teaching.yml, \_quarto.yml, freeze)
4. Hook status (installed, version)
5. Cache health (\_freeze/ size, last render)

**Interactive Fix:**

```bash
teach doctor

# Output:
â”‚  âœ— yq not found
â”‚  Install via Homebrew? [Y/n] y
â”‚  â†’ brew install yq
â”‚  âœ“ yq installed

â”‚  âœ— R package 'ggplot2' not found
â”‚  Install? [Y/n] y
â”‚  â†’ Rscript -e "install.packages('ggplot2')"
â”‚  âœ“ ggplot2 installed
```

**Testing:**

- `tests/test-teach-doctor-unit.zsh` - Health checks
- Mock missing dependencies
- Test interactive fix prompts

**Deliverable:** Comprehensive health check system

---

#### Week 5-7: Enhanced Deploy

**Goal:** Partial deploys with dependency tracking and index management

**Files to modify:**

- `lib/dispatchers/teach-dispatcher.zsh` - Deploy enhancements
- `lib/git-helpers.zsh` - Dependency tracking
- `lib/index-helpers.zsh` - NEW - Index management

**Deployment Features:**

1. **Partial Deploys:**

```bash
teach deploy lectures/week-05.qmd
# Deploy single file with dependencies
```

2. **Dependency Tracking:**

```zsh
_find_dependencies() {
    local file="$1"
    # Extract sourced files: source("path")
    grep -oP 'source\("\K[^"]+' "$file"
    # Extract cross-references: @sec-id
    grep -oP '@sec-\K[a-z0-9-]+' "$file" | while read sec; do
        grep -l "^#.*{#$sec}" **/*.qmd
    done
}
```

3. **Index Management (ADD/UPDATE/REMOVE):**

```bash
# Add new lecture
teach deploy lectures/week-05.qmd
# â†’ New lecture: "Week 5: Factorial ANOVA"
# â†’ Add to home_lectures.qmd? [Y/n] y

# Update existing lecture
# â†’ Old: "Week 5: ANOVA"
# â†’ New: "Week 5: Factorial ANOVA and Contrasts"
# â†’ Update link? [y/N] y

# Remove deprecated lecture
rm lectures/week-01.qmd
teach deploy
# â†’ Deleted: week-01.qmd
# â†’ Remove link? [Y/n] y
```

4. **Auto-Sorting:**

```zsh
# Parse week number from filename
# week-05.qmd â†’ sort_key = 5
# Support custom sort_order in YAML frontmatter
```

5. **Cross-Reference Validation:**

```zsh
_validate_cross_references() {
    local files=("$@")
    # Extract @sec-id, @fig-id, @tbl-id
    # Find target files
    # Check if targets exist and being deployed
}
```

6. **Auto-Commit + Auto-Tag:**

```zsh
# Auto-commit uncommitted changes
if ! git diff-index --quiet HEAD --; then
    read "msg?Commit message (or Enter for auto): "
    [[ -z "$msg" ]] && msg="Update: $(date +%Y-%m-%d)"
    git add . && git commit -m "$msg"
fi

# Auto-tag deployment
local tag="deploy-$(date +%Y-%m-%d-%H%M)"
git tag "$tag" && git push origin "$tag"
```

**Testing:**

- `tests/test-teach-deploy-unit.zsh` - Deploy logic
- `tests/test-index-management-unit.zsh` - ADD/UPDATE/REMOVE
- Test dependency tracking
- Test auto-sorting

**Deliverable:** Complete deployment system

---

#### Week 7: Backup System

**Goal:** Automated backup with retention policies

**Files to create:**

- `lib/backup-helpers.zsh` - Backup utilities
- `commands/teach-backup.zsh` - Backup management

**Backup Commands:**

```bash
teach backup create [name]     # Timestamped backup
teach backup list              # List backups
teach backup restore <name>    # Restore from backup
teach backup delete <name>     # Delete backup
teach backup archive           # Archive semester backups
```

**Backup Structure:**

```
.teach/backups/
â”œâ”€â”€ 2026-01-20-1430/          # Timestamped snapshots
â”‚   â”œâ”€â”€ _freeze/
â”‚   â”œâ”€â”€ lectures/
â”‚   â”œâ”€â”€ assignments/
â”‚   â””â”€â”€ _quarto.yml
â”œâ”€â”€ semester-archive/          # Long-term storage
â”‚   â””â”€â”€ spring-2026.tar.gz
â””â”€â”€ metadata.json              # Backup metadata
```

**Retention Policies:**

```yaml
# teaching.yml
backup:
  retention:
    daily: 7 # Keep 7 daily backups
    weekly: 4 # Keep 4 weekly backups
    semester: all # Keep all semester archives
```

**Testing:**

- `tests/test-teach-backup-unit.zsh` - Backup logic
- Test create/restore/delete
- Test retention policies

**Deliverable:** Automated backup system

---

#### Week 8: Enhanced Status

**Goal:** Comprehensive project dashboard

**Files to modify:**

- `lib/dispatchers/teach-dispatcher.zsh` - Enhance teach status

**Status Dashboard:**

```bash
teach status

# Output:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAT 545 - Spring 2026                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ Project: ~/projects/teaching/stat-545                       â”‚
â”‚  ğŸ”§ Quarto: Freeze âœ“ (71MB, 342 files)                         â”‚
â”‚  ğŸ£ Hooks: Pre-commit âœ“ (v2.0.0), Pre-push âœ“ (v2.0.0)          â”‚
â”‚  ğŸš€ Deployments: Last 4h ago (deploy-2026-01-20-1230)          â”‚
â”‚  ğŸ“š Index: 5 lectures, 5 assignments linked                     â”‚
â”‚  ğŸ’¾ Backups: 12 backups (850MB)                                 â”‚
â”‚  â±ï¸  Performance: Last render 38s (avg 42s)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Testing:**

- `tests/test-teach-status-unit.zsh` - Status dashboard
- Mock project state

**Deliverable:** Enhanced status dashboard

---

### PHASE 2: Enhancements (Weeks 9-12)

#### Week 9: Profile Management + R Package Detection

**Goal:** Quarto profiles and R auto-install

**Files to create:**

- `lib/profile-helpers.zsh` - Profile detection/switching
- `lib/r-helpers.zsh` - R package detection
- `lib/renv-integration.zsh` - renv support
- `commands/teach-profiles.zsh` - Profile management

**Profile Commands:**

```bash
teach profiles list             # List profiles
teach profiles show <name>      # Show profile config
teach profiles set <name>       # Switch profile
teach profiles create <name>    # Create profile
```

**R Package Auto-Install:**

```bash
teach doctor --fix

# New checks:
â”‚  âš   Missing R packages (from teaching.yml)
â”‚     â€¢ ggplot2, dplyr, tidyr
â”‚  Install all? [Y/n] y
â”‚  â†’ Installing R packages...
â”‚  âœ“ All R packages installed
```

**Testing:**

- `tests/test-teach-profiles-unit.zsh` - Profile management
- `tests/test-r-helpers-unit.zsh` - R package detection
- Test auto-install prompts

**Deliverable:** Profile system + R auto-install

---

#### Week 10-11: Parallel Rendering

**Goal:** 3-10x speedup with parallel rendering

**Files to create:**

- `lib/parallel-helpers.zsh` - Parallel rendering utilities
- `lib/render-queue.zsh` - Smart render queue

**Parallel Rendering:**

```bash
teach validate lectures/*.qmd

# Auto-detect cores:
# â†’ Detected 8 cores
# â†’ Rendering 12 files in parallel (8 workers)
#
# Progress:
# [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘] 67% (8/12) - 45s elapsed
#
# Results:
# âœ“ week-01.qmd (3s)
# âœ“ week-02.qmd (5s)
# â± week-03.qmd (15s...)
```

**Smart Queue:**

```zsh
_optimize_render_queue() {
    # Group by estimated render time
    # Fast files first (< 10s)
    # Slow files distributed across workers
    # Dependency-aware ordering
}
```

**Performance Stats:**

```bash
teach validate --stats

# Output:
â”‚  Total time: 45s
â”‚  Serial estimate: 156s
â”‚  Speedup: 3.5x
â”‚  Workers: 8
â”‚  Avg time: 3.8s per file
```

**Testing:**

- `tests/test-parallel-rendering-unit.zsh` - Parallel logic
- Test worker pool management
- Test progress reporting

**Deliverable:** Parallel rendering with 3-10x speedup

---

#### Week 11-12: Custom Validators + Advanced Caching

**Goal:** Extensible validation + cache optimization

**Files to create:**

- `lib/custom-validators.zsh` - Custom validation framework
- `.teach/validators/` - Built-in validators

**Custom Validators:**

```bash
teach validate --custom

# Runs validators from .teach/validators/
# Example: check-citations.zsh, check-links.zsh
```

**Validator Template:**

```zsh
#!/usr/bin/env zsh
# .teach/validators/check-citations.zsh

_validate() {
    local file="$1"
    local errors=()

    # Extract citations: [@author2020]
    local citations=($(grep -oP '\[@\K[a-z0-9-]+' "$file"))

    # Check if cited in bibliography
    for cite in $citations; do
        if ! grep -q "^$cite:" references.bib; then
            errors+=("Missing citation: $cite")
        fi
    done

    # Return errors
    [[ ${#errors[@]} -eq 0 ]]
}
```

**Advanced Caching:**

```bash
teach cache clear --lectures     # Clear lectures/ only
teach cache clear --old          # Clear > 30 days
teach cache analyze              # Detailed analysis
```

**Cache Analysis:**

```
â”‚  Total: 71MB (342 files)
â”‚  By Directory:
â”‚    lectures/      45MB (215 files)
â”‚    assignments/   22MB (108 files)
â”‚  By Age:
â”‚    < 7 days       18MB (85 files)
â”‚    > 30 days      22MB (99 files)
â”‚  Recommendation:
â”‚    â€¢ Clear > 30 days: Save 22MB
```

**Testing:**

- `tests/test-custom-validators-unit.zsh` - Validator framework
- `tests/test-advanced-caching-unit.zsh` - Selective caching

**Deliverable:** Custom validators + cache optimization

---

#### Week 12: Performance Monitoring

**Goal:** Track and visualize performance trends

**Files to create:**

- `lib/performance-monitor.zsh` - Performance tracking
- `.teach/performance-log.json` - Render statistics

**Performance Tracking:**

```bash
teach validate --benchmark

# Tracks:
# - Render time per file
# - Cache hit rate
# - Parallel efficiency
# - Total time
```

**Performance Dashboard:**

```bash
teach status --performance

# Output:
â”‚  Performance Trends (Last 7 Days)
â”‚  Avg Render Time:
â”‚    Today:     38s  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘
â”‚    Week avg:  45s  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â”‚  Cache Hit Rate:
â”‚    Today:     94%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“
â”‚    Week avg:  91%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘
â”‚  Parallel Speedup:
â”‚    Today:     3.5x â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘
```

**Testing:**

- `tests/test-performance-monitor-unit.zsh` - Tracking logic

**Deliverable:** Performance monitoring system

---

### PHASE 3: Advanced Features (Weeks 13-16)

#### Week 13-14: Template System

**Goal:** Course initialization from templates

**Files to create:**

- `lib/template-engine.zsh` - Template processing
- `templates/` - Built-in templates
- `commands/teach-templates.zsh` - Template management

**Template Structure:**

```
templates/
â”œâ”€â”€ basic/
â”‚   â”œâ”€â”€ template.yml              # Template metadata
â”‚   â”œâ”€â”€ _quarto.yml              # Quarto config
â”‚   â”œâ”€â”€ teaching.yml             # Flow-cli config
â”‚   â”œâ”€â”€ lectures/week-01-template.qmd
â”‚   â””â”€â”€ assignments/hw-01-template.qmd
â”œâ”€â”€ statistics/
â”‚   â”œâ”€â”€ template.yml
â”‚   â”œâ”€â”€ references.bib
â”‚   â””â”€â”€ R/helpers.R
â””â”€â”€ custom/
    â””â”€â”€ [user templates]
```

**Template Commands:**

```bash
teach templates list                    # List templates
teach templates show <name>             # Show details
teach templates apply <name>            # Apply to project
teach templates create <name>           # Create from project
teach templates import <url>            # Import from GitHub
```

**teach init --template:**

```bash
teach init --template statistics

# Interactive prompts:
# â†’ Course code: STAT 545
# â†’ Semester: Spring 2026
# â†’ Instructor: Dr. Smith
# â†’ GitHub repo: y
#
# Creates project from template with variable replacement
```

**Testing:**

- `tests/test-teach-templates-unit.zsh` - Template processing
- Test variable replacement
- Test GitHub import

**Deliverable:** Template system

---

#### Week 14: Advanced Backups

**Goal:** Compression, differential backups, cloud sync

**Files to modify:**

- `lib/backup-helpers.zsh` - Advanced features

**Advanced Backup:**

```bash
teach backup create --full              # Full project backup
teach backup create --content-only      # No _freeze/, _site/
teach backup create --differential      # From last backup
teach backup create --compress          # 850MB â†’ 120MB
```

**Backup Verification:**

```bash
teach backup verify <name>

# Checks:
# 1. Archive integrity (checksum)
# 2. File count matches metadata
# 3. Required files present
# âœ… Backup verified
```

**Cloud Sync (Optional):**

```bash
teach backup sync
# Sync to Dropbox/Google Drive/AWS S3
```

**Testing:**

- `tests/test-backup-advanced-unit.zsh` - Advanced features
- Test compression
- Test differential backups

**Deliverable:** Advanced backup system

---

#### Week 15: Auto-Rollback + Multi-Environment

**Goal:** CI failure detection and multi-env deployment

**Files to create:**

- `lib/ci-helpers.zsh` - CI integration
- `lib/rollback-helpers.zsh` - Rollback automation

**Auto-Rollback:**

```bash
teach deploy lectures/week-05.qmd

# Local validation passes
# Push to production
# â†’ CI build failed âŒ
#
# Auto-rollback triggered:
# â†’ Reverting to: deploy-2026-01-19-1430
# âœ… Rolled back automatically
```

**Rollback Configuration:**

```yaml
# teaching.yml
deploy:
  rollback:
    auto: true # Enable auto-rollback
    monitor_ci: true # Monitor CI build
    timeout: 10 # Max minutes for CI
```

**Multi-Environment:**

```bash
teach deploy --env staging        # Deploy to staging
teach deploy --promote stagingâ†’production  # Promote
```

**Environment Status:**

```bash
teach status --environments

# Shows: dev, staging, production
# Last deploy, commits behind, URLs
```

**Testing:**

- `tests/test-rollback-unit.zsh` - Rollback logic
- `tests/test-multi-env-unit.zsh` - Environment management

**Deliverable:** Auto-rollback + multi-environment

---

#### Week 16: Error Recovery + Migration

**Goal:** Smart error recovery and project migration

**Files to create:**

- `lib/error-recovery.zsh` - Error recovery utilities
- `lib/migration-helpers.zsh` - Migration utilities
- `commands/teach-migrate.zsh` - Migration command
- `commands/teach-errors.zsh` - Error history

**Smart Error Recovery:**

```bash
teach validate lectures/week-05.qmd

# Error detected:
# âœ— object 'data' not found
#
# Suggested fixes:
#   1. Check if data file loaded
#   2. Run: source("R/load-data.R")
#
# Attempt auto-fix? [Y/n] y
# â†’ Adding: source("R/load-data.R")
# âœ“ Validation passed
```

**Error History:**

```bash
teach errors

# Shows recent errors with fixes applied
# Helps prevent recurring issues
```

**Migration:**

```bash
teach migrate --from stat-545-old

# Detection:
# â†’ Existing: Standard Quarto
# â†’ No freeze caching, no hooks
#
# Migration plan:
#   1. Enable freeze
#   2. Install hooks
#   3. Create teaching.yml
#   4. Setup deployment
#
# âœ… Migration complete
```

**Testing:**

- `tests/test-error-recovery-unit.zsh` - Recovery logic
- `tests/test-migration-unit.zsh` - Migration logic

**Deliverable:** Error recovery + migration tools

---

## ğŸ“ Complete File Structure

```
flow-cli/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ hooks/                          # Phase 1
â”‚   â”‚   â”œâ”€â”€ pre-commit-template.zsh
â”‚   â”‚   â”œâ”€â”€ pre-push-template.zsh
â”‚   â”‚   â””â”€â”€ prepare-commit-msg-template.zsh
â”‚   â”œâ”€â”€ hook-installer.zsh              # Phase 1
â”‚   â”œâ”€â”€ validation-helpers.zsh          # Phase 1
â”‚   â”œâ”€â”€ cache-helpers.zsh               # Phase 1 + Phase 2
â”‚   â”œâ”€â”€ doctor-helpers.zsh              # Phase 1 + Phase 2
â”‚   â”œâ”€â”€ index-helpers.zsh               # Phase 1
â”‚   â”œâ”€â”€ backup-helpers.zsh              # Phase 1 + Phase 3
â”‚   â”œâ”€â”€ profile-helpers.zsh             # Phase 2
â”‚   â”œâ”€â”€ r-helpers.zsh                   # Phase 2
â”‚   â”œâ”€â”€ renv-integration.zsh            # Phase 2
â”‚   â”œâ”€â”€ parallel-helpers.zsh            # Phase 2
â”‚   â”œâ”€â”€ render-queue.zsh                # Phase 2
â”‚   â”œâ”€â”€ custom-validators.zsh           # Phase 2
â”‚   â”œâ”€â”€ performance-monitor.zsh         # Phase 2
â”‚   â”œâ”€â”€ template-engine.zsh             # Phase 3
â”‚   â”œâ”€â”€ ci-helpers.zsh                  # Phase 3
â”‚   â”œâ”€â”€ rollback-helpers.zsh            # Phase 3
â”‚   â”œâ”€â”€ error-recovery.zsh              # Phase 3
â”‚   â”œâ”€â”€ migration-helpers.zsh           # Phase 3
â”‚   â””â”€â”€ dispatchers/
â”‚       â””â”€â”€ teach-dispatcher.zsh        # MODIFIED (all phases)
â”œâ”€â”€ commands/
â”‚   â”œâ”€â”€ teach-validate.zsh              # Phase 1
â”‚   â”œâ”€â”€ teach-cache.zsh                 # Phase 1
â”‚   â”œâ”€â”€ teach-doctor.zsh                # Phase 1 + Phase 2
â”‚   â”œâ”€â”€ teach-backup.zsh                # Phase 1 + Phase 3
â”‚   â”œâ”€â”€ teach-profiles.zsh              # Phase 2
â”‚   â”œâ”€â”€ teach-templates.zsh             # Phase 3
â”‚   â”œâ”€â”€ teach-migrate.zsh               # Phase 3
â”‚   â””â”€â”€ teach-errors.zsh                # Phase 3
â”œâ”€â”€ templates/                          # Phase 3
â”‚   â”œâ”€â”€ basic/
â”‚   â”œâ”€â”€ statistics/
â”‚   â””â”€â”€ custom/
â””â”€â”€ tests/
    â”œâ”€â”€ test-teach-hooks-unit.zsh       # Phase 1
    â”œâ”€â”€ test-teach-validate-unit.zsh    # Phase 1
    â”œâ”€â”€ test-teach-cache-unit.zsh       # Phase 1
    â”œâ”€â”€ test-teach-doctor-unit.zsh      # Phase 1
    â”œâ”€â”€ test-teach-deploy-unit.zsh      # Phase 1
    â”œâ”€â”€ test-index-management-unit.zsh  # Phase 1
    â”œâ”€â”€ test-teach-backup-unit.zsh      # Phase 1
    â”œâ”€â”€ test-teach-status-unit.zsh      # Phase 1
    â”œâ”€â”€ test-teach-profiles-unit.zsh    # Phase 2
    â”œâ”€â”€ test-r-helpers-unit.zsh         # Phase 2
    â”œâ”€â”€ test-parallel-rendering-unit.zsh # Phase 2
    â”œâ”€â”€ test-custom-validators-unit.zsh # Phase 2
    â”œâ”€â”€ test-advanced-caching-unit.zsh  # Phase 2
    â”œâ”€â”€ test-performance-monitor-unit.zsh # Phase 2
    â”œâ”€â”€ test-teach-templates-unit.zsh   # Phase 3
    â”œâ”€â”€ test-backup-advanced-unit.zsh   # Phase 3
    â”œâ”€â”€ test-rollback-unit.zsh          # Phase 3
    â”œâ”€â”€ test-multi-env-unit.zsh         # Phase 3
    â”œâ”€â”€ test-error-recovery-unit.zsh    # Phase 3
    â””â”€â”€ test-migration-unit.zsh         # Phase 3
```

---

## ğŸ§ª Testing Strategy

### Unit Tests (Required for ALL features)

- Mock external dependencies (git, quarto, yq)
- Test all error paths
- Test interactive prompts
- Test all helper functions

### Integration Tests (Required)

- Test full workflow: init â†’ validate â†’ deploy
- Test with real STAT 545 project
- Test hook installation/upgrade
- Test rollback scenarios

### Performance Tests (Required)

- Pre-commit validation < 5s per file
- Parallel rendering 3-10x speedup
- teach deploy local < 60s
- CI build 2-5 min

---

## âœ… Definition of Done

### Code Complete

- [ ] All 21 commands implemented
- [ ] All 22 helper libraries created
- [ ] All 19 test suites passing (100% coverage)
- [ ] No linting errors
- [ ] Performance targets met

### Documentation Complete

- [ ] User guide: TEACHING-QUARTO-WORKFLOW.md (10,000+ lines)
- [ ] API reference: TEACH-DISPATCHER-REFERENCE.md updated
- [ ] All commands have examples
- [ ] Troubleshooting section complete

### Testing Complete

- [ ] Unit tests: 100% coverage
- [ ] Integration tests: All workflows
- [ ] Performance tests: All targets met
- [ ] Real project testing: STAT 545 validated

### Migration Complete

- [ ] teach init --upgrade works
- [ ] Backup existing hooks
- [ ] Non-destructive migration
- [ ] Rollback path tested

---

## ğŸ“– Reference Documentation

**Master Specifications:**

- `IMPLEMENTATION-READY-SUMMARY.md` - Complete feature checklist (84 decisions)
- `TEACH-DEPLOY-DEEP-DIVE.md` - Deployment workflow spec
- `PARTIAL-DEPLOY-INDEX-MANAGEMENT.md` - Index management spec
- `STAT-545-ANALYSIS-SUMMARY.md` - Production patterns from STAT 545
- `BRAINSTORM-quarto-workflow-enhancements-2026-01-20.md` - All 84 Q&A

**Key Decisions:**

- Q1-84: Expert questions covering all features
- Hybrid rendering architecture
- Interactive error handling (ADHD-friendly)
- Auto-commit + auto-tag workflow
- Dependency tracking algorithm
- 5-layer pre-commit validation

---

## ğŸ¯ Success Metrics

| Metric                 | Target          | Measurement                   |
| ---------------------- | --------------- | ----------------------------- |
| **Performance**        |
| Pre-commit (1 file)    | < 5s            | With freeze cache             |
| Pre-commit (5 files)   | < 10s           | Parallel rendering            |
| teach deploy (local)   | < 60s           | Hybrid validation             |
| CI build               | 2-5 min         | Full site render              |
| Parallel speedup       | 3-10x           | Compare serial vs parallel    |
| **Reliability**        |
| Broken commits         | 0%              | Pre-commit validation         |
| CI failures            | < 5%            | Local validation catches most |
| Hook conflicts         | 0               | Interactive upgrade           |
| **Adoption**           |
| New projects           | 100%            | Auto-configured               |
| Existing migrations    | 50% in 3 months | teach migrate                 |
| Documentation coverage | 100%            | All features documented       |

---

## ğŸš€ Getting Started

### Start Implementation

```bash
# 1. Navigate to worktree
cd ~/.git-worktrees/flow-cli/quarto-workflow/

# 2. Verify branch
git branch --show-current
# Should show: feature/quarto-workflow

# 3. Read this file completely
cat IMPLEMENTATION-INSTRUCTIONS.md | less

# 4. Start with Week 1-2: Hook System
# Follow the week-by-week schedule above
```

---

## ğŸ’¡ Implementation Tips

### ADHD-Friendly Workflow

- **Focus on one week at a time** - Don't look ahead
- **Celebrate small wins** - Each week is a milestone
- **Test frequently** - Don't accumulate untested code
- **Commit atomically** - Small, functional commits
- **Take breaks** - 16 weeks is a marathon, not a sprint

### Code Quality

- Follow existing flow-cli patterns
- Use helper functions from `lib/core.zsh`
- Add color output for better UX
- Test edge cases thoroughly
- Document complex logic

### Testing First

- Write tests before implementation (TDD)
- Mock external dependencies
- Test interactive prompts
- Validate performance targets

---

## ğŸ“‹ Weekly Checklist Template

Copy this for each week:

```
## Week X: [Feature Name]

### Planning
- [ ] Read feature specification
- [ ] Design file structure
- [ ] Identify dependencies
- [ ] Plan testing strategy

### Implementation
- [ ] Create helper files
- [ ] Implement core functions
- [ ] Add command interface
- [ ] Add error handling
- [ ] Add interactive prompts

### Testing
- [ ] Write unit tests
- [ ] Run tests (all passing)
- [ ] Test edge cases
- [ ] Test performance

### Documentation
- [ ] Update API reference
- [ ] Add usage examples
- [ ] Update changelog

### Review
- [ ] Code review (self)
- [ ] Performance check
- [ ] Commit with message
```

---

**Created:** 2026-01-20
**Branch:** feature/quarto-workflow
**Target:** v4.6.0 â†’ v4.8.0 (Complete)
**Timeline:** 16 weeks
**Status:** âœ… Ready for implementation
