#compdef flow

# Completion for flow command

_flow() {
  local -a commands
  local -a adhd_commands
  local -a capture_commands
  local -a action_commands
  local -a timer_commands
  local -a learn_commands

  commands=(
    'help:Show help for flow commands'
    'version:Show version'
    # Core workflow
    'work:Start a focused work session'
    'pick:Interactive project picker'
    'dash:Show project dashboard'
    'finish:End session, optionally commit'
    'hop:Quick switch projects (tmux)'
    'why:Show current context'
    # ADHD helpers
    'start:Just start - picks a project for you'
    'js:Just start (alias for start)'
    'stuck:When you are blocked - get unstuck'
    'focus:Set your current focus'
    'next:What should I work on?'
    'break:Take a proper break'
    'brk:Take a break (alias)'
    # Capture
    'catch:Quick capture to inbox'
    'crumb:Leave breadcrumb in project'
    'inbox:View your inbox'
    'win:Log a win'
    'status:View/update .STATUS file'
    # Actions
    'test:Run tests (context-aware)'
    'build:Build project (context-aware)'
    'preview:Preview project output'
    'sync:Smart git sync'
    'check:Health check (lint, types)'
    'plan:Sprint/project planning'
    'log:Activity log'
    # Timer
    'timer:Focus timer'
    'morning:Morning startup routine'
    # Learning
    'learn:Interactive tutorial'
    'tutorial:Interactive tutorial (alias)'
    # Setup & Diagnostics
    'doctor:Check dependencies & health'
    'setup:Interactive setup wizard'
    'install:Install tools with profiles'
    'upgrade:Update flow-cli and tools'
    # AI-Powered
    'ai:Ask AI anything'
    'do:Natural language commands'
    # Plugins
    'plugin:Manage flow-cli plugins'
    # Configuration
    'config:Manage configuration and profiles'
  )

  local curcontext="$curcontext" state line
  typeset -A opt_args

  _arguments -C \
    '1: :->command' \
    '*: :->args'

  case $state in
    command)
      _describe -t commands 'flow command' commands
      ;;
    args)
      case $line[1] in
        pick|pp)
          local -a categories
          categories=(
            'r:R packages'
            'dev:Development tools'
            'q:Quarto projects'
            'teach:Teaching courses'
            'rs:Research projects'
            'app:Applications'
          )
          _describe -t categories 'category' categories
          ;;
        work)
          # Complete project names
          local -a projects
          projects=(${(f)"$(command ls -d ~/projects/*/* 2>/dev/null | xargs -n1 basename 2>/dev/null)"})
          _describe -t projects 'project' projects
          ;;
        dash)
          local -a scopes
          scopes=(
            'dev:Development tools'
            'r:R packages'
            'teach:Teaching'
            'rs:Research'
            'all:All projects'
          )
          _describe -t scopes 'scope' scopes
          ;;
        learn|tutorial)
          local -a levels
          levels=(
            'beginner:Core workflow lessons'
            'medium:Productivity tools'
            'advanced:Power features'
            'reset:Reset progress'
            'progress:Show current progress'
            'run:Run named tutorial'
          )
          _describe -t levels 'level' levels
          ;;
        test)
          local -a test_opts
          test_opts=(
            '--watch:Watch mode'
            '-w:Watch mode'
            '--coverage:Run with coverage'
            '--verbose:Verbose output'
          )
          _describe -t options 'option' test_opts
          ;;
        timer)
          local -a timer_actions
          timer_actions=(
            'status:Check remaining time'
            'stop:Cancel timer'
            '5:5 minute timer'
            '15:15 minute timer'
            '25:25 minute pomodoro'
            '45:45 minute deep work'
          )
          _describe -t actions 'action' timer_actions
          ;;
        status)
          local -a status_actions
          status_actions=(
            'set:Set progress (0-100)'
            'next:Set next action'
            'all:View all project statuses'
          )
          _describe -t actions 'action' status_actions
          ;;
        plan)
          local -a plan_actions
          plan_actions=(
            'sprint:Sprint planning view'
            'roadmap:Show roadmap'
            'edit:Edit TODO.md or .STATUS'
          )
          _describe -t actions 'action' plan_actions
          ;;
        log)
          local -a log_periods
          log_periods=(
            'today:Today activity'
            'week:This week activity'
            'recent:Recent activity'
          )
          _describe -t periods 'period' log_periods
          ;;
        sync)
          # Check if we're completing the first arg (target) or subsequent args (options)
          if [[ ${#line[@]} -eq 2 ]]; then
            local -a sync_targets
            sync_targets=(
              'all:Sync everything (session → status → wins → goals → git)'
              'session:Persist current session to worklog'
              'status:Update .STATUS timestamps and streaks'
              'wins:Aggregate project wins to global wins.md'
              'goals:Recalculate daily goal progress'
              'git:Smart git push/pull with stash handling'
              'schedule:Manage automated sync schedule'
              'help:Show sync help'
            )
            local -a sync_opts
            sync_opts=(
              '--status:Show sync dashboard'
              '--dry-run:Preview changes without executing'
              '-n:Dry run (short)'
              '--verbose:Show detailed output'
              '-v:Verbose (short)'
              '--quiet:Minimal output for scripts'
              '-q:Quiet (short)'
              '--skip-git:Skip git sync for quick local sync'
              '--help:Show help'
              '-h:Help (short)'
            )
            _describe -t targets 'sync target' sync_targets
            _describe -t options 'option' sync_opts
          elif [[ "${line[2]}" == "schedule" ]]; then
            # Schedule subcommands
            local -a schedule_cmds
            schedule_cmds=(
              'status:Show schedule status'
              'enable:Enable scheduled sync (default: 30 min)'
              'disable:Disable scheduled sync'
              'logs:View sync schedule logs'
              'help:Show schedule help'
            )
            _describe -t commands 'schedule command' schedule_cmds
          else
            # Completing options after target
            local -a sync_opts
            sync_opts=(
              '--dry-run:Preview changes'
              '-n:Dry run (short)'
              '--verbose:Detailed output'
              '-v:Verbose (short)'
              '--quiet:Minimal output'
              '-q:Quiet (short)'
              '--skip-git:Skip git sync'
            )
            _describe -t options 'option' sync_opts
          fi
          ;;
        help)
          # Complete command names for help
          local -a help_topics
          help_topics=(
            'work' 'pick' 'dash' 'finish' 'status' 'timer' 'tutorial'
            'test' 'build' 'sync' 'check' 'plan' 'doctor' 'setup'
            'install' 'upgrade' 'ai' 'do' 'stuck' 'next'
            '--list' '-l'
            '--search' '-s'
          )
          _describe -t topics 'topic' help_topics
          ;;
        doctor)
          local -a doctor_opts
          doctor_opts=(
            '--fix:Interactive install missing tools'
            '-f:Interactive install (short)'
            '--ai:AI-assisted troubleshooting'
            '-a:AI assist (short)'
            '--update-docs:Regenerate documentation'
            '-u:Update docs (short)'
            '--yes:Skip confirmations'
            '-y:Skip confirmations (short)'
            '--verbose:Verbose output'
            '-v:Verbose (short)'
            '--help:Show help'
          )
          _describe -t options 'option' doctor_opts
          ;;
        install)
          local -a install_opts
          install_opts=(
            '--profile:Install from profile'
            '-p:Profile (short)'
            '--category:Install from category'
            '-c:Category (short)'
            '--dry-run:Show what would be installed'
            '-n:Dry run (short)'
            '--force:Reinstall even if present'
            '-f:Force (short)'
            '--list:List available profiles'
            '-l:List (short)'
            '--help:Show help'
          )
          local -a profiles
          profiles=(
            'minimal:Essential tools (fzf, zoxide, bat)'
            'developer:Full dev setup'
            'researcher:Academic tools'
            'writer:Publishing tools'
            'full:Everything'
          )
          _describe -t options 'option' install_opts
          _describe -t profiles 'profile' profiles
          ;;
        upgrade)
          local -a upgrade_targets
          upgrade_targets=(
            'self:Update flow-cli itself'
            'tools:Update Homebrew packages'
            'plugins:Update ZSH plugins'
            'all:Update everything'
            '--check:Check for updates only'
            '-c:Check (short)'
            '--changelog:Show what is new'
            '--force:Skip confirmations'
            '-f:Force (short)'
            '--help:Show help'
          )
          _describe -t targets 'target' upgrade_targets
          ;;
        ai)
          # Check for subcommand
          if [[ ${#line[@]} -eq 2 ]]; then
            local -a ai_subcmds
            ai_subcmds=(
              'recipe:Reusable AI prompts'
              'chat:Interactive conversation mode'
              'usage:Usage statistics and suggestions'
              'model:Manage AI models'
            )
            local -a ai_opts
            ai_opts=(
              '--context:Include project context'
              '-c:Context (short)'
              '--explain:Explain mode'
              '-e:Explain (short)'
              '--fix:Fix mode'
              '-f:Fix (short)'
              '--suggest:Suggest mode'
              '-s:Suggest (short)'
              '--create:Create mode'
              '--model:Select model (opus, sonnet, haiku)'
              '-m:Model (short)'
              '--verbose:Verbose output'
              '-v:Verbose (short)'
              '--help:Show help'
            )
            _describe -t commands 'ai subcommand' ai_subcmds
            _describe -t options 'option' ai_opts
          elif [[ "${line[2]}" == "recipe" ]]; then
            local -a recipes
            recipes=(
              'list:List all recipes'
              'show:View recipe content'
              'create:Create new recipe'
              'edit:Edit user recipe'
              'delete:Delete user recipe'
              'review:Code review'
              'commit:Generate commit message'
              'explain-code:Explain code step by step'
              'debug:Help debug an issue'
              'refactor:Suggest refactoring'
              'test:Generate tests'
              'document:Generate documentation'
              'eli5:Explain simply'
              'shell:Generate shell commands'
              'fix:Fix a problem'
            )
            _describe -t recipes 'recipe' recipes
          elif [[ "${line[2]}" == "chat" ]]; then
            local -a chat_opts
            chat_opts=(
              '--context:Enable project context'
              '-c:Context (short)'
              '--clear:Clear conversation history'
              '--history:Show conversation history'
              '--help:Show help'
            )
            _describe -t options 'option' chat_opts
          elif [[ "${line[2]}" == "usage" ]]; then
            local -a usage_actions
            usage_actions=(
              'stats:Show usage statistics'
              'suggest:Get personalized suggestions'
              'recent:Show recent AI activity'
              'clear:Clear usage history'
              'help:Show help'
            )
            _describe -t actions 'action' usage_actions
          elif [[ "${line[2]}" == "model" ]]; then
            local -a model_actions
            model_actions=(
              'show:Show current model'
              'list:List available models'
              'set:Set default model'
              'opus:Claude Opus (most capable)'
              'sonnet:Claude Sonnet (balanced)'
              'haiku:Claude Haiku (fast)'
              'help:Show help'
            )
            _describe -t actions 'action' model_actions
          fi
          ;;
        do)
          local -a do_opts
          do_opts=(
            '--dry-run:Show command without executing'
            '-n:Dry run (short)'
            '--verbose:Verbose output'
            '-v:Verbose (short)'
            '--help:Show help'
          )
          _describe -t options 'option' do_opts
          ;;
        stuck)
          local -a stuck_opts
          stuck_opts=(
            '--ai:AI help when blocked'
            '-a:AI help (short)'
            '--help:Show help'
          )
          _describe -t options 'option' stuck_opts
          ;;
        next)
          local -a next_opts
          next_opts=(
            '--ai:AI-powered suggestion'
            '-a:AI (short)'
            '--help:Show help'
          )
          _describe -t options 'option' next_opts
          ;;
        plugin)
          local -a plugin_cmds
          plugin_cmds=(
            'list:List installed plugins'
            'enable:Enable a disabled plugin'
            'disable:Disable a plugin'
            'create:Create a new plugin'
            'install:Install plugin from path/GitHub'
            'remove:Remove a user plugin'
            'info:Show plugin details'
            'hooks:Show registered hooks'
            'path:Show plugin search paths'
          )
          _describe -t commands 'plugin command' plugin_cmds
          ;;
        config)
          local -a config_cmds
          config_cmds=(
            'show:Show all configuration'
            'get:Get a specific config value'
            'set:Set a config value'
            'edit:Open config in editor'
            'reset:Reset config to defaults'
            'save:Save current config to file'
            'reload:Reload config from file'
            'wizard:Interactive configuration wizard'
            'profile:Manage configuration profiles'
            'export:Export config in shell format'
            'path:Show config file paths'
          )
          _describe -t commands 'config command' config_cmds
          ;;
        *)
          _files
          ;;
      esac
      ;;
  esac
}

_flow "$@"
