#compdef dots

# Completion for dots command - dotfile management dispatcher

_dots() {
  local -a subcommands
  local -a files

  # Subcommands
  subcommands=(
    'status:Show dotfile sync status'
    's:Show dotfile sync status (alias)'
    'help:Show help message'
    'version:Show version information'
    'add:Add file to chezmoi'
    'edit:Edit a dotfile with preview (auto-add/create)'
    'e:Edit a dotfile (alias)'
    'sync:Pull changes from remote'
    'pull:Pull changes from remote (alias)'
    'push:Push changes to remote'
    'p:Push changes to remote (alias)'
    'diff:Show pending changes'
    'd:Show pending changes (alias)'
    'apply:Apply pending changes'
    'a:Apply pending changes (alias)'
    'ignore:Manage .chezmoiignore patterns'
    'ig:Manage .chezmoiignore patterns (alias)'
    'size:Analyze repository size'
    'doctor:Run diagnostics'
    'dr:Run diagnostics (alias)'
    'undo:Rollback last apply'
    'init:Initialize dotfile management'
    'env:Direnv integration'
  )

  # Get managed files if chezmoi is available
  if command -v chezmoi &>/dev/null; then
    local managed_files
    managed_files=(${(f)"$(chezmoi managed 2>/dev/null)"})
    for f in $managed_files; do
      files+=("${f:t}:${f}")
    done
  fi

  _arguments -C \
    '1:subcommand:->subcommand' \
    '*::arg:->args' \
  && return 0

  case "$state" in
    subcommand)
      _describe -t subcommands 'dots subcommand' subcommands
      ;;
    args)
      case "$line[1]" in
        add)
          _files
          ;;
        edit|e)
          _alternative \
            'files:managed file:_describe -t files managed\ file files' \
            'paths:file path:_files'
          ;;
        diff|d|apply|a)
          _describe -t files 'managed file' files
          ;;
        ignore|ig)
          if [[ ${#line[@]} -eq 1 ]]; then
            local -a ignore_cmds
            ignore_cmds=(
              'add:Add ignore pattern'
              'list:List all patterns'
              'ls:List all patterns (alias)'
              'remove:Remove ignore pattern'
              'rm:Remove ignore pattern (alias)'
              'edit:Edit .chezmoiignore in $EDITOR'
              'help:Show ignore command help'
            )
            _describe -t ignore 'ignore command' ignore_cmds
          fi
          ;;
        env)
          if [[ ${#line[@]} -eq 1 ]]; then
            local -a env_cmds
            env_cmds=(
              'init:Initialize direnv for current project'
              'help:Show env command help'
            )
            _describe -t env 'env command' env_cmds
          fi
          ;;
      esac
      ;;
  esac
}

_dots "$@"
