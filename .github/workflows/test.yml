name: CI Tests

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  zsh-tests:
    name: ZSH Plugin Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: zsh
          version: 1.0

      - name: Record start time
        id: start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Create mock project structure
        run: |
          mkdir -p ~/projects/dev-tools/flow-cli/.git
          mkdir -p ~/projects/r-packages/active/mediationverse/.git
          mkdir -p ~/projects/r-packages/stable/rmediation/.git
          mkdir -p ~/projects/teaching/stat-440/.git
          mkdir -p ~/projects/research/mediation-planning/.git
          mkdir -p ~/projects/quarto/manuscripts/paper1/.git
          mkdir -p ~/projects/apps/examify/.git
          cp -r . ~/projects/dev-tools/flow-cli/

      - name: Run smoke tests
        run: |
          cd ~/projects/dev-tools/flow-cli
          # Smoke tests only - run full suite locally with: ./tests/run-all.sh
          zsh ./tests/test-flow.zsh
          bash ./tests/test-install.sh

      - name: Performance Summary
        if: always()
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - ${{ steps.start.outputs.time }}))
          echo "## ðŸ“Š ZSH Tests Performance" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Duration | ${DURATION}s |" >> $GITHUB_STEP_SUMMARY
