name: CI Tests

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  zsh-tests:
    name: ZSH Plugin Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install zsh
        run: sudo apt-get update && sudo apt-get install -y zsh

      - name: Record start time
        id: start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Create mock project structure
        run: |
          mkdir -p ~/projects/dev-tools/flow-cli/.git
          mkdir -p ~/projects/r-packages/active/mediationverse/.git
          mkdir -p ~/projects/r-packages/stable/rmediation/.git
          mkdir -p ~/projects/teaching/stat-440/.git
          mkdir -p ~/projects/research/mediation-planning/.git
          mkdir -p ~/projects/quarto/manuscripts/paper1/.git
          mkdir -p ~/projects/apps/examify/.git
          cp -r . ~/projects/dev-tools/flow-cli/

      - name: Run tests
        run: |
          cd ~/projects/dev-tools/flow-cli
          # Dispatcher tests
          zsh ./tests/test-pick-smart-defaults.zsh
          zsh ./tests/test-cc-dispatcher.zsh
          zsh ./tests/test-g-feature.zsh
          zsh ./tests/test-wt-dispatcher.zsh
          zsh ./tests/test-r-dispatcher.zsh
          zsh ./tests/test-qu-dispatcher.zsh
          zsh ./tests/test-mcp-dispatcher.zsh
          zsh ./tests/test-obs-dispatcher.zsh
          # Core command tests
          zsh ./tests/test-dash.zsh
          zsh ./tests/test-work.zsh
          zsh ./tests/test-doctor.zsh
          zsh ./tests/test-capture.zsh
          zsh ./tests/test-pick-wt.zsh
          zsh ./tests/test-adhd.zsh
          zsh ./tests/test-flow.zsh
          zsh ./tests/test-timer.zsh
          # CLI tests
          bash ./tests/cli/automated-tests.sh
          bash ./tests/test-install.sh

      - name: Performance Summary
        if: always()
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - ${{ steps.start.outputs.time }}))
          echo "## ðŸ“Š ZSH Tests Performance" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Duration | ${DURATION}s |" >> $GITHUB_STEP_SUMMARY
