name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # Test install.sh in Docker before release
  install-test:
    name: Install Script Test
    runs-on: ubuntu-latest

    strategy:
      matrix:
        container:
          - ubuntu:22.04
          - debian:bookworm
          - alpine:3.20

    container:
      image: ${{ matrix.container }}

    steps:
      - name: Install dependencies
        run: |
          if command -v apk >/dev/null 2>&1; then
            apk add --no-cache git zsh curl bash
          elif command -v apt-get >/dev/null 2>&1; then
            apt-get update
            apt-get install -y git zsh curl
          fi

      - name: Checkout
        uses: actions/checkout@v6

      - name: Run install.sh unit tests
        run: bash ./tests/test-install.sh

      - name: Test curl install (dry run simulation)
        shell: bash
        run: |
          # Test that install.sh can be executed standalone
          bash -n ./install.sh
          echo "✓ install.sh syntax valid"

          # Test detection in clean environment
          export HOME=/tmp/test-home
          mkdir -p $HOME
          touch $HOME/.zshrc

          # Source just the detection function and test it
          detect_plugin_manager() {
            if [[ -n "${INSTALL_METHOD:-}" ]]; then
              echo "$INSTALL_METHOD"
              return
            fi
            if [[ -f "${ZDOTDIR:-$HOME}/.zsh_plugins.txt" ]]; then
              echo "antidote"
            elif [[ -d "$HOME/.zinit" ]]; then
              echo "zinit"
            elif [[ -d "$HOME/.oh-my-zsh" ]]; then
              echo "omz"
            else
              echo "manual"
            fi
          }

          result=$(detect_plugin_manager)
          if [[ "$result" == "manual" ]]; then
            echo "✓ Clean environment detected as 'manual'"
          else
            echo "✗ Expected 'manual', got '$result'"
            exit 1
          fi

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: install-test

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # NOTE: npm test commented out - no test script in package.json
      # ZSH tests run in install-test job above
      # - name: Run tests
      #   run: npm test

      - name: Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npx semantic-release
